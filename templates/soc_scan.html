<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SafeFile SOC Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/soc_base.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/soc_scan.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


</head>
<body>
  <!-- Top Navigation Bar -->
  <header class="topbar">
    <div class="left">
      <a href="{{ url_for('auth.index') }}" class="back-arrow">←</a>
      <nav class="nav-links">
        <a href="{{ url_for('soc.soc_home') }}">Home</a>
        <a href="{{ url_for('soc.soc_scan') }}" class="active">Scan</a>
        <a href="{{ url_for('soc.soc_history') }}">History</a>
        <a href="{{ url_for('soc.soc_logs') }}">Logs</a>
      </nav>
    </div>

       <div class="Logo">
        <div class="logo-combo">
            <img src="{{ url_for('static', filename='img/small_logo.png') }}" alt="SafeFile icon" class="icon">
             <img src="{{ url_for('static', filename='img/text-logo.png') }}" alt="SafeFile logo text" class="logo-text">
         </div>
        </div>
  </header>

<main class="content scan-page">
  

<div class="upload-container">
  <h2>Upload Files for Scanning</h2>
<div class="upload-actions">

        <!-- FILE UPLOAD BUTTON -->
        <form method="POST" enctype="multipart/form-data" id="fileForm">
         <label class="upload-btn file-btn">
          <input type="file" name="single_files" multiple hidden onchange="document.getElementById('fileForm').submit();">
            <svg class="btn-icon" viewBox="0 0 24 24">
             <path d="M12 3v12m0-12l-4 4m4-4l4 4M5 21h14a2 2 0 0 0 2-2v-5H3v5a2 2 0 0 0 2 2z"
              stroke="#5924d0" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
               Upload File
          </label>
        </form>

        <!-- FOLDER UPLOAD BUTTON -->
        <form method="POST" enctype="multipart/form-data" id="folderForm">
         <label class="upload-btn folder-btn">
          <input type="file" name="folder_files" webkitdirectory hidden onchange="document.getElementById('folderForm').submit();">
            <svg class="btn-icon" viewBox="0 0 24 24">
             <path d="M3 7h6l2 2h10v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" stroke="#5924d0" stroke-width="2" fill="none"
              stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
               Upload Folder
         </label>
        </form>
      </div>
    </div>

    <!-- FILE MESSAGE -->
    {% if file_message %}
      <div class="result-message">
        {{ file_message }}
      </div>
    {% endif %}




        {% if uploaded_files and not analysis_results %}
      <div class="folder-results">
        <h3>Files to Scan</h3>

        <table>
          <tr>
            <th>File Name</th>
          </tr>
          {% for f in uploaded_files %}
          <tr>
            <td>{{ f.display_name }}</td>
          </tr>
          {% endfor %}
        </table>

        <!-- Scan button form -->
        <form method="POST" class="scan-form">
          {# send saved filenames back to the server #}
          {% for f in uploaded_files %}
            <input type="hidden" name="files_to_scan" value="{{ f.saved_name }}">
          {% endfor %}
          <button type="submit"
                  name="action"
                  value="scan"
                  class="upload-btn file-btn">
            Scan Files
          </button>
        </form>
      </div>
    {% endif %}


    

{% if analysis_results %}
  <div class="scan-results">
    <h3>Scan Results</h3>

    {# Header row for the summary table #}
    <div class="scan-header">
      <span class="col-file">File Name</span>
      <span class="col-type">File Type</span>
      <span class="col-verdict">Final Verdict</span>
    </div>

    {# One expandable card per file #}
    {% for r in analysis_results %}
      <details class="file-card">
        <summary class="file-summary-row">
          <div class="file-main">
            <span class="arrow"></span>
            <span class="file-name">{{ r.display_name }}</span>
          </div>
          
          <span class="file-type">{{ r.final_type or "Unknown" }}</span>
          <!-- placeholder for future verdict -->
          <span class="badge badge-neutral">-</span>
        </summary>

        <div class="file-details">

          <!-- File Type Detection -->
<div class="detail-section section-card filetype-card">

  <h4 class="result-title">File Type Detection</h4>

 <table class="ft-table">

    <tr>
      <td class="result-label">Declared Extension:</td>
      <td><span class="pill-neutral">{{ r.declared_extension or "-" }}</span></td>
    </tr>


    <tr>
      <td class="result-label">Magic Type:</td>
      <td><span class="pill-neutral">{{ r.magic_type or "-" }}</span></td>
    </tr>


    <tr>
      <td class="result-label">Detected Type:</td>
      <td><span class="pill-neutral">{{ r.final_type or "Unknown" }}</span></td>
    </tr>


    <tr>
      <td class="result-label">Detected MIME:</td>
      <td><span class="pill-neutral">{{ r.final_mime or "-" }}</span></td>
    </tr>

    <tr>
      <td class="result-label">Type Mismatch:</td>
      <td>
        {% if r.mismatch %}
          <span class="pill-bad">Mismatch</span>
        {% else %}
          <span class="pill-good">No</span>
        {% endif %}
      </td>
    </tr>
  </table>
  </ul>
</div>


{#---------- 2 Entropy Analysis – TABLE LAYOUT -------------#}
{% set e = r.entropy %}
{% if e %}
  {% set overall = e.overall_entropy %}
  {% if overall is not none %}

    {# classify overall entropy #}
    {% if overall < 5 %}
      {% set entropy_label = "Low" %}
      {% set entropy_class = "entropy-low" %}
    {% elif overall < 7 %}
      {% set entropy_label = "Normal" %}
      {% set entropy_class = "entropy-normal" %}
    {% elif overall < 7.8 %}
      {% set entropy_label = "High" %}
      {% set entropy_class = "entropy-high" %}
    {% else %}
      {% set entropy_label = "Very High" %}
      {% set entropy_class = "entropy-very-high" %}
    {% endif %}

    {% set pe = e.pe_report %}
    {% set interp = e.pe_interpretation %}

    <div class="detail-section section-card entropy-card">
      <h4 class="result-title">Entropy Analysis</h4>

      {# -------- TOP ROW: OVERALL & RISK SCORE -------- #}
      <div class="entropy-top-grid">
        <div class="entropy-meta-card">
          <table class="kv-table">
            <tr>
              <th colspan="2" class="result-label">Overall Shannon Entropy</th>
            </tr>
            <tr>
              <td class="kv-label">Value</td>
              <td class="kv-value">
                <span class="pill-entropy {{ entropy_class }}">
                  {{ "%.2f"|format(overall) }} / 8.00
                </span>
                <span class="entropy-level-text">{{ entropy_label }}</span>
              </td>
            </tr>
          </table>
        </div>

        {% if interp %}
        <div class="entropy-meta-card">
          <table class="kv-table">
            <tr>
              <th colspan="2" class="result-label">PE Entropy Risk Score</th>
            </tr>
            <tr>
              <td class="kv-label">Score</td>
              <td class="kv-value">
                <span class="pill-entropy-risk">
                  {{ interp.risk_score }}/100
                </span>
              </td>
            </tr>
          </table>
        </div>
        {% endif %}
      </div>

      {# -------- BOTTOM ROW: SECTIONS & INTERPRETATION -------- #}
      {% if pe and pe.is_pe %}
      <div class="entropy-bottom-grid">

        {# LEFT: Section entropy table #}
        {% if pe.sections %}
        <div class="entropy-table-wrapper">
          <h5 class="result-label">PE Section Entropy</h5>
          <table class="detail-table entropy-section-table">
            <thead>
              <tr>
                <th>Section</th>
                <th>Entropy</th>
                <th>Comment</th>
              </tr>
            </thead>
            <tbody>
              {% for sec in pe.sections %}
              <tr>
                <td>{{ sec.name }}</td>
                <td>{{ "%.2f"|format(sec.entropy) if sec.entropy is not none else "-" }}</td>
                <td>{{ sec.comment if sec.comment is defined else "-" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}

        {# RIGHT: PE interpretation table #}
        {% if interp %}
        <div class="entropy-table-wrapper">
          <h5 class="result-label">PE Interpretation</h5>

          {% if interp.flags %}
          <table class="detail-table entropy-interpret-table">
            <thead>
              <tr><th>Flags</th></tr>
            </thead>
            <tbody>
              {% for flag in interp.flags %}
              <tr>
                <td>{{ flag }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}

          {% if interp.notes %}
          <table class="detail-table entropy-interpret-table entropy-notes-table">
            <thead>
              <tr><th>Notes</th></tr>
            </thead>
            <tbody>
              {% for note in interp.notes %}
              <tr>
                <td>{{ note }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}
        </div>
        {% endif %}

      </div>
      {% endif %}
    </div>  {# /entropy-card #}

  {% endif %}
{% endif %}


<!-- 3) YARA Rule Matches -->
<div class="detail-section section-card yara-card">

  <h4 class="result-title">YARA Rule Matches</h4>

  {% if not r.yara %}
    <p class="muted-text">No YARA data available for this file.</p>

  {% elif not r.yara.enabled %}
    <p class="muted-text">YARA scanning is disabled (no rules compiled).</p>

  {% elif r.yara.error %}
    <p class="muted-text">
      Error while scanning file with YARA:
    </p>
    <div class="code-block">{{ r.yara.error }}</div>

  {% elif r.yara.matches %}
    <p>The following YARA rule(s) matched this file:</p>

    <div class="yara-table-wrapper">
      <table class="yara-table">
        <thead>
          <tr>
            <th>Rule Name</th>
            <th>Description</th>
            <th>Severity</th>
            <th>Namespace</th>
            <th>Tags</th>
          </tr>
        </thead>
        <tbody>
          {% for m in r.yara.matches %}
          <tr>
            <td><strong>{{ m.rule }}</strong></td>

            <td>
              {% if m.meta.description is defined %}
                {{ m.meta.description }}
              {% else %}
                <span class="muted-text">No description</span>
              {% endif %}
            </td>

            <td>
              {% if m.meta.severity is defined %}
                {{ m.meta.severity }}
              {% else %}
                <span class="muted-text">N/A</span>
              {% endif %}
            </td>

            <td>{{ m.namespace or "-" }}</td>

            <td>
              {% if m.tags %}
                {{ m.tags | join(", ") }}
              {% else %}
                <span class="muted-text">None</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  {% else %}
    <p class="muted-text">No YARA rules matched this file.</p>
  {% endif %}

</div>



          


          <!-- 4) VirusTotal  -->
          {% set vt = r.virustotal %}
          <div class="detail-section section-card">
            <h4 class="result-title">VirusTotal Summary</h4>

            {# Safety: no VT data at all #}
            {% if not vt %}
              <p class="muted-text">
                No VirusTotal data available for this file.
              </p>

            {# VT disabled because no API key configured #}
            {% elif not vt.enabled %}
              <p class="muted-text">
                VirusTotal is not configured (API key missing).
              </p>

            {# VT was called but there was an error (network, rate limit, etc.) #}
            {% elif vt.error %}
              <p class="muted-text">
                VirusTotal error: {{ vt.error }}
              </p>

            {# VT worked, but hash not found in their database #}
            {% elif not vt.found %}
              <p class="muted-text">
                No VirusTotal report found for this file hash.
              </p>

            {# VT worked and we have a proper report #}
            {% else %}
              <ul class="kv-list">
                <li>
                  <span class="result-label">Verdict</span>
                  <span class="result-value">
                    {{ vt.verdict|capitalize }}
                  </span>
                </li>
                <li>
                  <span class="result-label">Detections</span>
                  <span class="result-value">
                    {{ vt.malicious }} / {{ vt.total_engines }} engines
                  </span>
                </li>
                <li>
                  <span class="result-label">Harmless</span>
                  <span class="result-value">
                    {{ vt.harmless }}
                  </span>
                </li>
                <li>
                  <span class="result-label">Undetected</span>
                  <span class="result-value">
                    {{ vt.undetected }}
                  </span>
                </li>
                <li>
                  <span class="result-label">File SHA-256</span>
                  <span class="result-value">
                    <code>{{ vt.sha256 }}</code>
                  </span>
                </li>
                {% if vt.permalink %}
                <li>
                  <span class="result-label">Full Report</span>
                  <span class="result-value">
                    <a href="{{ vt.permalink }}" target="_blank">
                      Open on VirusTotal
                    </a>
                  </span>
                </li>
                {% endif %}
              </ul>
            {% endif %}
          </div>

          <!-- 5) ML Verdict – placeholder -->
          <div class="detail-section section-card">
            <h4>ML Verdict</h4>
            <p class="muted-text">
              Machine learning verdict and score will be displayed here later.
            </p>
          </div>



          <!-- 6) Analyst Notes -->
          <div class="detail-section">
            <h4>Analyst Notes</h4>
            <div class="note-block">
              (Final analyst notes and combined verdict will appear here.)
            </div>
          </div>

        </div>
      </details>
    {% endfor %}
  </div>
{% endif %}



</main>

{% if error_message %}
<script>
Swal.fire({
  icon: 'error',
  title: 'Upload Error',
  html: '{{ error_message }}',
  confirmButtonColor: '#6d28d9',
  width: 500
})
</script>
{% endif %}


</body>
</html>
