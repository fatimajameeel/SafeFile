// static/js/malware_type_pie.js
// Builds the "Threat Categories" pie/doughnut chart on the SOC dashboard

document.addEventListener("DOMContentLoaded", function () {
  const data = window.malwareTypeData || [];

  // If there's no data yet, don't try to render the chart
  if (!Array.isArray(data) || data.length === 0) {
    console.warn("No malwareTypeData available â€“ skipping Threat Categories chart.");
    return;
  }

  const canvas = document.getElementById("malwareTypeChart");
  if (!canvas) {
    console.warn("malwareTypeChart canvas not found.");
    return;
  }

  const ctx = canvas.getContext("2d");

  // Labels (for legend) and values (for slice sizes)
  const labels = data.map(item => `${item.label} ${item.percent}%`);
  const counts = data.map(item => item.count);

  // Choose colors per label so it's consistent and readable
  const backgroundColors = labels.map((label, index) => pickColorForLabel(label, index));


  new Chart(ctx, {
    type: "pie",
    data: {
      labels: labels,
      datasets: [
        {
          data: counts,
          backgroundColor: backgroundColors,
          borderWidth: 1,
          borderColor: "#ffffff"
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: "right",
          labels: {
            usePointStyle: true,
            boxWidth: 10,
            font: {
              size: 11
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              const index = context.dataIndex;
              const item = data[index];
              // Example tooltip: "EICAR/Test: 5 (20.0%)"
              return `${item.label}: ${item.count} (${item.percent}%)`;
            }
          }
        }
      }
    }
  });
});


/**
 * Map a malware type label to a specific color.
 * Keeps the colors consistent every time.
 */
const purpleShades = [
  "#2E0F5F", // darkest purple
  "#4A228E", // deep violet
  "#6A40C4", // bold purple
  "#8660F0", // base theme purple
  "#AB92FF", // soft lavender
  "#D8CCFF"  // very light lavender
];



function pickColorForLabel(label, index) {
  return purpleShades[index % purpleShades.length];
}
