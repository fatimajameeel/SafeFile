from collections import Counter
from db import get_db


"""
    Take the raw 'malware_type' string from the database and map it into
    a clean category label for the pie chart.

    Examples:
      "Virus.Eicar/Test"        -> "EICAR/Test"
      "Malware (unspecified)"   -> "Malware (unspecified)"
      "Trojan"                  -> "Trojan"
      None or ""                -> "Unknown"
"""


def normalize_malware_label(raw_type: str) -> str:
    if not raw_type:
        return "Unknown"

    mt = raw_type.strip().lower()

    # EICAR test file
    if "eicar" in mt:
        return "EICAR/Test"

    # Trojan
    if "trojan" in mt:
        return "Trojan Horse"

      # Backdoor
    if "backdoor" in mt:
        return "Backdoor"

    # Worm
    if "worm" in mt:
        return "Worm"

    # Generic / unspecified malware
    if "malware (unspecified)" in mt:
        return "Malware (unspecified)"

    # If we get here, it is some other label we don't explicitly handle
    # We can either return it as-is (capitalized) or group it as "Other".
    # Here we'll show the original type (with first letter uppercased) so it is visible.
    return raw_type.strip()


"""
    Compute the distribution of malware types across ALL rows in the 'file' table.

    We:
      - read malware_type for every row where it is not completely NULL/empty
      - normalize each value into a clean category (using normalize_malware_label)
      - count how many times each category appears
      - compute the percentage for each category

    Returns a list like:
      [
        {"label": "EICAR/Test", "count": 10, "percent": 38.5},
        {"label": "Malware (unspecified)", "count": 8, "percent": 30.8},
        ...
      ]

"""


def get_malware_type_breakdown():
    db = get_db()
    cursor = db.cursor()

    # 1) Get raw malware_type values and their counts from the database.
    # skip rows where malware_type is NULL or an empty string,
    # because they don't give us any category information.
    cursor.execute(
        """
        SELECT malware_type, COUNT(*) AS cnt
        FROM file
        WHERE malware_type IS NOT NULL
              AND TRIM(malware_type) <> ''
        GROUP BY malware_type
        """
    )

    rows = cursor.fetchall()
    # 2) Use a Counter to accumulate counts per normalized label.
    #
    # Example:
    #   Counter({
    #       "EICAR/Test": 12,
    #       "Malware (unspecified)": 9,
    #       "Trojan": 4,
    #       "Unknown": 2,
    #   })
    category_counter = Counter()

    for raw_type, cnt in rows:
        label = normalize_malware_label(raw_type)
        category_counter[label] += cnt or 0

    # If there were absolutely no malware_type entries, return an empty list.
    total_count = sum(category_counter.values())
    if total_count == 0:
        return []

    # 3) Build a list of dictionaries with label, count, and percentage.
    #
    # We also sort the categories by count (largest first) so the pie chart
    # and legend show the most important categories first.
    result = []
    for label, count in category_counter.most_common():
        percent = (count / total_count) * 100.0

        result.append(
            {
                "label": label,
                "count": count,
                "percent": round(percent, 1),  # one decimal place, e.g. 39.4
            }
        )

    return result
