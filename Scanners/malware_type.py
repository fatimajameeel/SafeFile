from typing import Any, Dict, List, Optional


def infer_malware_type(
    vt_report: Optional[Dict[str, Any]],
    yara_report: Optional[Dict[str, Any]],
) -> Optional[Dict[str, str]]:
    """
    Use your simplified VirusTotal + YARA results to guess a malware type.

    Returns either:
        {
            "label": "Trojan",
            "source": "VirusTotal" or "YARA",
            "details": "Detected as Trojan by 10 engine(s)"
        }
    or:
        None
    """

    # -----------------
    # 1) Try VirusTotal
    # -----------------
    if vt_report and vt_report.get("found") and not vt_report.get("error"):
        malicious = int(vt_report.get("malicious", 0) or 0)
        verdict = (vt_report.get("verdict") or "").lower()
        type_label = vt_report.get("threat_label")

        # If no explicit label, try scanning VT tags for keywords
        if not type_label:
            tags = vt_report.get("tags") or []
            for t in tags:
                lower = str(t).lower()
                if any(
                    kw in lower
                    for kw in [
                        "trojan",
                        "ransom",
                        "ransomware",
                        "worm",
                        "spyware",
                        "keylogger",
                        "stealer",
                        "backdoor",
                        "rootkit",
                        "dropper",
                        "loader",
                        "banker",
                    ]
                ):
                    type_label = t
                    break

        if malicious > 0 and type_label:
            cleaned = str(type_label).replace("_", " ").strip().title()
            return {
                "label": cleaned,
                "source": "VirusTotal",
                "details": f"Detected as {cleaned} by {malicious} engine(s)",
            }

        # (If malicious==0 or no label, we don't classify from VT and fall back to YARA)

    # --------------
    # 2) Try YARA
    # --------------
    matches: List[Dict[str, Any]] = (yara_report or {}).get("matches") or []

    if matches:
        text_chunks: List[str] = []
        for m in matches:
            rule_name = str(m.get("rule", ""))
            text_chunks.append(rule_name)

            meta = m.get("meta") or {}
            for k, v in meta.items():
                text_chunks.append(f"{k}={v}")

        combined = " ".join(text_chunks).lower()

        keyword_mapping = [
            ("ransom", "Ransomware"),
            ("crypto", "Ransomware"),
            ("stealer", "Information Stealer"),
            ("keylog", "Keylogger"),
            ("spy", "Spyware"),
            ("backdoor", "Backdoor"),
            ("botnet", "Botnet"),
            ("worm", "Worm"),
            ("rootkit", "Rootkit"),
            ("dropper", "Dropper"),
            ("loader", "Downloader/Loader"),
            ("banker", "Banking Trojan"),
            ("trojan", "Trojan"),
        ]

        for keyword, label in keyword_mapping:
            if keyword in combined:
                return {
                    "label": label,
                    "source": "YARA",
                    "details": f"Inferred from YARA match: contains '{keyword}'",
                }

        # YARA matched but we couldn't infer a specific type
        return {
            "label": "Malware (unspecified)",
            "source": "YARA",
            "details": "YARA rules matched but type could not be determined",
        }

    # ---------------
    # 3) No info
    # ---------------
    return None
